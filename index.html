<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="Configuration management using files (JSON, YAML, separated text),
JSON strings, and command line arguments.
">
<title>tryr: Manage R Configuration at the Command Line • tryr</title>
<script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="tryr: Manage R Configuration at the Command Line">
<meta property="og:description" content="Configuration management using files (JSON, YAML, separated text),
JSON strings, and command line arguments.
">
<meta property="og:image" content="https://hub.analythium.io/assets/web/tryr.png">
<meta property="og:image:alt" content="tryr: Try/catch mechanisms for Plumber APIs">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:creator" content="@psolymos">
<meta name="twitter:site" content="@analythium">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><script src="https://cdn.usefathom.com/script.js" data-site="XXTESXHY" defer></script><link rel="icon" href="https://hub.analythium.io/assets/logo/grays/favicon.ico">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="index.html">tryr</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.1</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="reference/index.html">Reference</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="http://twitter.com/analythium" aria-label="Twitter">
    <span class="fa fa-twitter"></span>
     
  </a>
</li>
<li class="nav-item">
  <a class="external-link nav-link" href="http://github.com/analythium" aria-label="GitHub">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-home">
<div class="row">
  <main id="main" class="col-md-9"><div class="section level1">
<div class="page-header"><h1 id="tryr-clientserver-error-handling-for-plumber-apis">tryr: Client/Server Error Handling for Plumber APIs<a class="anchor" aria-label="anchor" href="#tryr-clientserver-error-handling-for-plumber-apis"></a>
</h1></div>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"analythium/tryr"</span><span class="op">)</span></span></code></pre></div>
<p>In client/server setups, the client might send user input that is incorrect. In such cases the front end application needs to know that the 4xx error status indicates that the message needs to be relayed to the user to correct the input.</p>
<p>As opposed to this, when the server fails due to unexpected reasons, the client only needs to know that an error with 5xx status happened. Logs are essential for backend developers to diagnose the problem.</p>
<div class="section level2">
<h2 id="problem-statement">Problem statement<a class="anchor" aria-label="anchor" href="#problem-statement"></a>
</h2>
<p>The Plumber R package implements a simple error catching hook that converts all responses that are an error condition to a status code 500 - Internal Server Error.</p>
<p>Let’s see this for an example API:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">plumber</span><span class="fu">::</span><span class="fu">pr</span><span class="op">(</span><span class="st">"inst/examples/plumber.R"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">plumber</span><span class="fu">::</span><span class="fu">pr_set_debug</span><span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">plumber</span><span class="fu">::</span><span class="fu">pr_run</span><span class="op">(</span>port<span class="op">=</span><span class="fl">8000</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="default-behavior">Default behavior<a class="anchor" aria-label="anchor" href="#default-behavior"></a>
</h3>
<p>We use a handler calling the function <code>foo()</code>: note that the contents of the response also depend on the <code>pr_set_debug()</code> settings that depends on whether we use interactive or non-interactive session. This is now turned off so that we can see the ‘production’ behavior.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">foo</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">x</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"'x' is too low."</span><span class="op">)</span></span>
<span>  <span class="st">"Success!"</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#* @post /test</span></span>
<span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">foo</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Here are the responses from this <code>/test</code> endpoint for various specification of the <code>x</code> parameter:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true"></a><span class="co"># --- Request ---</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true"></a><span class="co"># curl -X POST "http://localhost:8000/test?x=0"</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true"></a><span class="co"># --- Response ---</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true"></a><span class="co"># ["Success!"]</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true"></a><span class="co"># --- STDOUT ---</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true"></a><span class="co"># </span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true"></a><span class="co"># --- STDERR ---</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true"></a><span class="co"># --- Request ---</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true"></a><span class="co"># curl -X POST "http://localhost:8000/test?x=-1"</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true"></a><span class="co"># --- Response ---</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true"></a><span class="co"># {"error":"500 - Internal server error"}</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true"></a><span class="co"># --- STDOUT ---</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true"></a><span class="co"># &lt;simpleError in foo(x = x): 'x' is too low.&gt;</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true"></a><span class="co"># --- STDERR ---</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true"></a></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true"></a><span class="co"># --- Request ---</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true"></a><span class="co"># curl -X POST "http://localhost:8000/test?x=a"</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true"></a><span class="co"># --- Response ---</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true"></a><span class="co"># {"error":"500 - Internal server error"}</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true"></a><span class="co"># --- STDOUT ---</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true"></a><span class="co"># &lt;simpleError in if (x &lt; 0) stop("'x' is too low."): missing value where TRUE/FALSE needed&gt;</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true"></a><span class="co"># --- STDERR ---</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true"></a><span class="co"># Warning in foo(x = x) : NAs introduced by coercion</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true"></a></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true"></a><span class="co"># --- Request ---</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true"></a><span class="co"># curl -X POST "http://localhost:8000/test?x="</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true"></a><span class="co"># --- Response ---</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true"></a><span class="co"># {"error":"500 - Internal server error"}</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true"></a><span class="co"># --- STDOUT ---</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true"></a><span class="co"># &lt;simpleError in foo(x = x): argument "x" is missing, with no default&gt;</span></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true"></a><span class="co"># --- STDERR ---</span></span></code></pre></div>
<p>As you can see, the response has a generic 500 HTTP status irrespective of nature of the error. On the back end, the error is printed to STDOUT, whereas a warning got printed to STDERR.</p>
<p>This default behavior is undesired for multiple reasons:</p>
<ul>
<li>We need to be able to differentiate 4xx and 5xx errors</li>
<li>The detailed error message is helpful on the backend, but we should print it to STDERR instead of STDOUT</li>
</ul>
<p>Warning: when <code>pr_set_debug(TRUE)</code> the error message itself is returned by the response, this might contain sensitive information that we should not leak to the client.</p>
</div>
</div>
<div class="section level2">
<h2 id="trycatch-behavior">Try/catch behavior<a class="anchor" aria-label="anchor" href="#trycatch-behavior"></a>
</h2>
<p>Alternatively, we can use some functions from tryr to handle these inconveniences:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bar</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/warning.html" class="external-link">suppressWarnings</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu">tryr</span><span class="fu">::</span><span class="fu"><a href="reference/http-messages.html">http_error</a></span><span class="op">(</span><span class="fl">400L</span>, <span class="st">"Unexpected input."</span><span class="op">)</span></span>
<span>  <span class="fu">foo</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#* @post /try</span></span>
<span><span class="kw">function</span><span class="op">(</span><span class="va">req</span>, <span class="va">res</span>, <span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">tryr</span><span class="fu">::</span><span class="fu"><a href="reference/http-try.html">http_try</a></span><span class="op">(</span><span class="va">req</span>, <span class="va">res</span>, <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/missing.html" class="external-link">missing</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"'x' is missing"</span>, call. <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>    <span class="fu">bar</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Here are the outputs from the <code>/try</code> endpoint for the same requests as before:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true"></a><span class="co"># --- Request ---</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true"></a><span class="co"># curl -X POST "http://localhost:8000/try?x=0"</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true"></a><span class="co"># --- Response ---</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true"></a><span class="co"># ["Success!"]</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true"></a><span class="co"># --- STDOUT ---</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true"></a><span class="co"># 94671 | 2022-11-04 20:55:53.403 [SUCCESS] Status 200: OK</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true"></a><span class="co"># --- STDERR ---</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true"></a></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true"></a><span class="co"># --- Request ---</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true"></a><span class="co"># curl -X POST "http://localhost:8000/try?x=-1"</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true"></a><span class="co"># --- Response ---</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true"></a><span class="co"># {"category":"Server Error","status":500,"message":"Internal Server Error"}</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true"></a><span class="co"># --- STDOUT ---</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true"></a><span class="co"># </span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true"></a><span class="co"># --- STDERR ---</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true"></a><span class="co"># 94683 | 2022-11-04 20:55:54.470 [ERROR  ] Status 500: Internal Server Error - Error in foo(x) : 'x' is too low.</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true"></a></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true"></a><span class="co"># --- Request ---</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true"></a><span class="co"># curl -X POST "http://localhost:8000/try?x=a"</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true"></a><span class="co"># --- Response ---</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true"></a><span class="co"># {"category":"Client Error","status":400,"message":"Bad Request - Unexpected input."}</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true"></a><span class="co"># --- STDOUT ---</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true"></a><span class="co"># </span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true"></a><span class="co"># --- STDERR ---</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true"></a><span class="co"># 94695 | 2022-11-04 20:55:55.533 [ERROR  ] Status 400: Bad Request - Unexpected input.</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true"></a></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true"></a><span class="co"># --- Request ---</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true"></a><span class="co"># curl -X POST "http://localhost:8000/try?x="</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true"></a><span class="co"># --- Response ---</span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true"></a><span class="co"># {"category":"Server Error","status":500,"message":"Internal Server Error"}</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true"></a><span class="co"># --- STDOUT ---</span></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true"></a><span class="co"># </span></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true"></a><span class="co"># --- STDERR ---</span></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true"></a><span class="co"># 94709 | 2022-11-04 20:55:56.601 [ERROR  ] Status 500: Internal Server Error - Error : 'x' is missing</span></span></code></pre></div>
<p>Now we can see that:</p>
<ul>
<li>Successful response (200) leaves a trace in STDOUT</li>
<li>We can differentiate 4xx and 5xx errors</li>
<li>When the error is 5xx, the error message is not included</li>
<li>The detailed error message is printed to STDERR</li>
</ul>
<p>So how did we do it? Here is what you get in tryr: we used <code><a href="reference/http-try.html">http_try()</a></code>. It is a wrapper that can handle <em>expected</em> and <em>unexpected</em> errors. Expected errors give the desired HTTP statuses using <code><a href="reference/http-messages.html">http_error()</a></code>. Unexpected error are returned by <code><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop()</a></code> and we have very little control over those (i.e. these were written by someone else).</p>
</div>
<div class="section level2">
<h2 id="implementation">Implementation<a class="anchor" aria-label="anchor" href="#implementation"></a>
</h2>
<p>The logic inside <code><a href="reference/http-try.html">http_try()</a></code> is this:</p>
<p><em>If we catch an error:</em></p>
<ul>
<li>the error is a clear server error coming from <code><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop()</a></code><ul>
<li>log it as an ERROR + print the error message to STDERR</li>
<li>return a generic status 500 message</li>
<li>set the status code of the response object to 500</li>
</ul>
</li>
<li>the error is a structured HTTP error coming from <code><a href="reference/http-messages.html">http_error()</a></code><ul>
<li>log it as an ERROR with the message from the condition attribute</li>
<li>return the specific HTTP error code with the structured output</li>
<li>set the status code of the response object</li>
</ul>
</li>
</ul>
<p><em>If we don’t catch an error:</em></p>
<ul>
<li>the object is of class <code><a href="reference/http-messages.html">http_success()</a></code> (this comes in handy for async jobs and redirects)<ul>
<li>log it as a SUCCESS with the message element</li>
<li>return the specific HTTP status code with the structured output</li>
<li>set the status code of the response object</li>
</ul>
</li>
<li>the object is NOT of class <code><a href="reference/http-messages.html">http_success()</a></code><ul>
<li>log it as a SUCCESS with a generic 200 message</li>
<li>return the object as is (default status code 200 assumed)</li>
</ul>
</li>
</ul>
<p>Log messages are handled by the <code>msg</code> function. Here is how you can add a preroute hook: we add a logger to print incoming request info (HTTP method and route) to STDOUT. For the sake of better ingesting the logs we can set the logging type to JSON (or CSV) and the timestamp precision to 6 digits.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Sys.setenv.html" class="external-link">Sys.setenv</a></span><span class="op">(</span></span>
<span>  TRYR_LOG_FORMAT <span class="op">=</span> <span class="st">"JSON"</span>,</span>
<span>  TRYR_LOG_DIGITS <span class="op">=</span> <span class="st">"6"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu">plumber</span><span class="fu">::</span><span class="fu">pr</span><span class="op">(</span><span class="st">"inst/examples/plumber.R"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">plumber</span><span class="fu">::</span><span class="fu">pr_set_debug</span><span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">plumber</span><span class="fu">::</span><span class="fu">pr_hooks</span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      preroute <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">req</span>, <span class="va">res</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="fu">tryr</span><span class="fu">::</span><span class="fu"><a href="reference/msg.html">msg</a></span><span class="op">(</span></span>
<span>          title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span></span>
<span>            method <span class="op">=</span> <span class="va">req</span><span class="op">$</span><span class="va">REQUEST_METHOD</span>, </span>
<span>            path <span class="op">=</span> <span class="va">req</span><span class="op">$</span><span class="va">PATH_INFO</span></span>
<span>          <span class="op">)</span>,</span>
<span>          level <span class="op">=</span> <span class="st">"INFO"</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">plumber</span><span class="fu">::</span><span class="fu">pr_run</span><span class="op">(</span></span>
<span>    port <span class="op">=</span> <span class="fl">8000</span>,</span>
<span>    quiet <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>Output:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true"></a><span class="co"># --- Request ---</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true"></a><span class="co"># curl -X POST "http://localhost:8000/try?x=0"</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true"></a><span class="co"># --- Response ---</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true"></a><span class="co"># ["Success!"]</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true"></a><span class="co"># --- STDOUT ---</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true"></a><span class="co"># {"pid":"94723","ts":"2022-11-04 20:55:57.643161","ut":1667616957.64312,"level":"INFO","value":3,"title":"POST /try","message":""}</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true"></a><span class="co"># {"pid":"94723","ts":"2022-11-04 20:55:57.670125","ut":1667616957.6701,"level":"SUCCESS","value":4,"title":"Status 200: OK","message":""}</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true"></a><span class="co"># --- STDERR ---</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true"></a></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true"></a><span class="co"># --- Request ---</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true"></a><span class="co"># curl -X POST "http://localhost:8000/try?x=-1"</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true"></a><span class="co"># --- Response ---</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true"></a><span class="co"># {"category":"Server Error","status":500,"message":"Internal Server Error"}</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true"></a><span class="co"># --- STDOUT ---</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true"></a><span class="co"># {"pid":"94735","ts":"2022-11-04 20:55:58.715163","ut":1667616958.71513,"level":"INFO","value":3,"title":"POST /try","message":""}</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true"></a><span class="co"># --- STDERR ---</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true"></a><span class="co"># {"pid":"94735","ts":"2022-11-04 20:55:58.745654","ut":1667616958.74564,"level":"ERROR","value":6,"title":"Status 500: Internal Server Error","message":"Error in foo(x) : 'x' is too low."}</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true"></a></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true"></a><span class="co"># --- Request ---</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true"></a><span class="co"># curl -X POST "http://localhost:8000/try?x=a"</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true"></a><span class="co"># --- Response ---</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true"></a><span class="co"># {"category":"Client Error","status":400,"message":"Bad Request - Unexpected input."}</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true"></a><span class="co"># --- STDOUT ---</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true"></a><span class="co"># {"pid":"94747","ts":"2022-11-04 20:55:59.783082","ut":1667616959.78305,"level":"INFO","value":3,"title":"POST /try","message":""}</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true"></a><span class="co"># --- STDERR ---</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true"></a><span class="co"># {"pid":"94747","ts":"2022-11-04 20:55:59.811228","ut":1667616959.81121,"level":"ERROR","value":6,"title":"Status 400: Bad Request - Unexpected input.","message":""}</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true"></a></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true"></a><span class="co"># --- Request ---</span></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true"></a><span class="co"># curl -X POST "http://localhost:8000/try?x="</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true"></a><span class="co"># --- Response ---</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true"></a><span class="co"># {"category":"Server Error","status":500,"message":"Internal Server Error"}</span></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true"></a><span class="co"># --- STDOUT ---</span></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true"></a><span class="co"># {"pid":"94759","ts":"2022-11-04 20:56:00.84779","ut":1667616960.84776,"level":"INFO","value":3,"title":"POST /try","message":""}</span></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true"></a><span class="co"># --- STDERR ---</span></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true"></a><span class="co"># {"pid":"94759","ts":"2022-11-04 20:56:00.874516","ut":1667616960.87449,"level":"ERROR","value":6,"title":"Status 500: Internal Server Error","message":"Error : 'x' is missing"}</span></span></code></pre></div>
<p>Structured errors are handled by the <code><a href="reference/http-messages.html">http_error()</a></code> function that uses default error messages as defined in the <code>http_status_codes</code> data frame.</p>
<p>The <code><a href="reference/http-messages.html">http_success()</a></code> works similarly but it does not produce an error. It can also pass a <code>body</code> argument. This is useful if we need to return simple status messages when responding to webhooks during async execution.</p>
<p>The <code><a href="reference/http-messages.html">http_response()</a></code> can be used for any of the status codes and is behind the <code><a href="reference/http-messages.html">http_handler()</a></code> function that is useful to set default handlers for Plumber:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">plumber</span><span class="fu">::</span><span class="fu">pr</span><span class="op">(</span><span class="st">"inst/examples/plumber.R"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">plumber</span><span class="fu">::</span><span class="fu">pr_set_debug</span><span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">plumber</span><span class="fu">::</span><span class="fu">pr_set_404</span><span class="op">(</span></span>
<span>    <span class="kw">function</span><span class="op">(</span><span class="va">req</span>, <span class="va">res</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu">tryr</span><span class="fu">::</span><span class="fu"><a href="reference/msg.html">msg</a></span><span class="op">(</span></span>
<span>        title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span></span>
<span>          <span class="st">"Status 404: "</span>, </span>
<span>          <span class="fu">tryr</span><span class="fu">::</span><span class="va"><a href="reference/http_status_codes.html">http_status_codes</a></span><span class="op">[</span><span class="st">"404"</span>, <span class="st">"message"</span><span class="op">]</span><span class="op">)</span>,</span>
<span>        level <span class="op">=</span> <span class="st">"INFO"</span></span>
<span>      <span class="op">)</span></span>
<span>      <span class="fu">tryr</span><span class="fu">::</span><span class="fu"><a href="reference/http-messages.html">http_handler</a></span><span class="op">(</span><span class="va">req</span>, <span class="va">res</span>, <span class="fl">404L</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">plumber</span><span class="fu">::</span><span class="fu">pr_set_error</span><span class="op">(</span></span>
<span>    <span class="kw">function</span><span class="op">(</span><span class="va">req</span>, <span class="va">res</span>, <span class="va">err</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu">tryr</span><span class="fu">::</span><span class="fu"><a href="reference/msg.html">msg</a></span><span class="op">(</span></span>
<span>        title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span></span>
<span>          <span class="st">"Status 500: "</span>, </span>
<span>          <span class="fu">tryr</span><span class="fu">::</span><span class="va"><a href="reference/http_status_codes.html">http_status_codes</a></span><span class="op">[</span><span class="st">"500"</span>, <span class="st">"message"</span><span class="op">]</span><span class="op">)</span>,</span>
<span>        message <span class="op">=</span> <span class="va">err</span>,</span>
<span>        level <span class="op">=</span> <span class="st">"ERROR"</span></span>
<span>      <span class="op">)</span></span>
<span>      <span class="fu">tryr</span><span class="fu">::</span><span class="fu"><a href="reference/http-messages.html">http_handler</a></span><span class="op">(</span><span class="va">req</span>, <span class="va">res</span>, <span class="fl">500L</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">plumber</span><span class="fu">::</span><span class="fu">pr_hooks</span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      preroute <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">req</span>, <span class="va">res</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="fu">tryr</span><span class="fu">::</span><span class="fu"><a href="reference/msg.html">msg</a></span><span class="op">(</span></span>
<span>          title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span></span>
<span>            method <span class="op">=</span> <span class="va">req</span><span class="op">$</span><span class="va">REQUEST_METHOD</span>, </span>
<span>            path <span class="op">=</span> <span class="va">req</span><span class="op">$</span><span class="va">PATH_INFO</span></span>
<span>          <span class="op">)</span>,</span>
<span>          level <span class="op">=</span> <span class="st">"INFO"</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">plumber</span><span class="fu">::</span><span class="fu">pr_run</span><span class="op">(</span></span>
<span>    port <span class="op">=</span> <span class="fl">8000</span>, </span>
<span>    quiet <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="see-the-action">See the action<a class="anchor" aria-label="anchor" href="#see-the-action"></a>
</h2>
<p>The <code>inst/examples</code> folder contains Shiny apps that you can edit and use to explore the differences between Plumber’s default error handling (<code>/test</code> endpoint) and the tryr approach (<code>/tryr</code> endpoint). See the response, request, STDOUT and STDERR from the calls:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/source.html" class="external-link">source</a></span><span class="op">(</span><span class="st">"inst/examples/app.R"</span><span class="op">)</span></span></code></pre></div>
<p>The second app is more general. You can edit the <code>plumber_fun</code> function definition and explore your own API’s output printed to STDOUT and STDERR:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/source.html" class="external-link">source</a></span><span class="op">(</span><span class="st">"inst/examples/explore.R"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="other-considerations">Other considerations<a class="anchor" aria-label="anchor" href="#other-considerations"></a>
</h2>
<p><a href="https://cran.r-project.org/web/packages/tryCatchLog/vignettes/tryCatchLog-intro.html" class="external-link uri">https://cran.r-project.org/web/packages/tryCatchLog/vignettes/tryCatchLog-intro.html</a></p>
<p>STDOUT is buffered, needs a flush. STDERR is unbuffered, more immediate <a href="https://unix.stackexchange.com/questions/331611/do-progress-reports-logging-information-belong-on-stderr-or-stdout" class="external-link uri">https://unix.stackexchange.com/questions/331611/do-progress-reports-logging-information-belong-on-stderr-or-stdout</a></p>
</div>
</div>
  </main><aside class="col-md-3"><div class="links">
<h2 data-toc-skip>Links</h2>
<ul class="list-unstyled">
<li><a href="https://github.com/analythium/tryr/" class="external-link">Browse source code</a></li>
<li><a href="https://github.com/analythium/tryr/issues" class="external-link">Report a bug</a></li>
</ul>
</div>

<div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small><a href="https://opensource.org/licenses/mit-license.php" class="external-link">MIT</a> + file <a href="LICENSE-text.html">LICENSE</a></small></li>
</ul>
</div>


<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing tryr</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Peter Solymos <br><small class="roles"> Author, maintainer </small> <a href="https://orcid.org/0000-0001-7337-1740" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a> </li>
<li>Analythium Solutions Inc. <br><small class="roles"> Copyright holder, funder </small>  </li>
</ul>
</div>



  </aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Peter Solymos, Analythium Solutions Inc..</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
